# Story E14.2 — Sprint Issue Assignment (Add Issues to Sprint)

**Epic:** E14 — Sprint Planning & Issue Assignment
**Status:** Ready for Dev
**Priority:** High
**Depends on:** E14.1

---

## Story

Como usuário do FlowBoard,
Quero adicionar Stories e Tasks a uma sprint específica,
Para planejar o trabalho de cada sprint e acompanhar o progresso.

---

## Contexto

Após a correção da E14.1, as sprints aparecem na tela. O próximo passo é permitir que o usuário associe issues (Stories, Tasks) a uma sprint. O backend já aceita `sprint_id` em `UpdateIssueRequest`. A operação é: atualizar o `sprint_id` do issue para o ID da sprint desejada.

---

## Acceptance Criteria

### AC1 — Botão "Add Issues" no Sprint Card
- Cada sprint em status `planning` ou `active` exibe um botão "Add Issues"
- Ao clicar, abre um modal/drawer com a lista de issues do backlog (sem sprint ou `sprint_id = null`)

### AC2 — Seleção de issues para a sprint
- O modal exibe issues do tipo Story, Task e Bug do projeto que ainda não têm sprint atribuída
- Cada issue exibe: tipo (ícone), key, título, prioridade
- O usuário pode selecionar múltiplos issues via checkbox
- Botão "Add to Sprint" confirma a seleção

### AC3 — Persistência
- Ao confirmar, cada issue selecionado é atualizado via `PATCH /projects/{id}/issues/{issueId}` com `{ sprint_id: sprintId }`
- Usa `useUpdateIssue` em loop ou batch
- Após sucesso, a lista de issues da sprint é atualizada (invalidar `issueKeys.byProject`)

### AC4 — Remover issue da sprint
- No `SprintCard`, cada issue exibe botão "Remove from Sprint" (ícone X)
- Ao clicar, atualiza o issue com `{ sprint_id: null }`

### AC5 — UX
- Estado de loading durante a operação de adição
- Feedback de erro se a operação falhar
- Issues já na sprint não aparecem como opção para adicionar

---

## Dev Notes

**Arquivos a criar/modificar:**
- `frontend/src/components/sprints/AddIssuesToSprintDialog.tsx` — novo componente modal
- `frontend/src/components/sprints/SprintCard.tsx` — adicionar botão "Add Issues" e botão "Remove"
- `frontend/src/hooks/useIssues.ts` — usar `useUpdateIssue` existente para atribuir sprint

**Fluxo de dados:**
```
SprintCard
  → botão "Add Issues"
    → AddIssuesToSprintDialog(projectId, sprintId, currentSprintIssueIds)
      → useIssues(projectId) para buscar backlog
      → filtra issues sem sprint_id
      → useUpdateIssue para cada selecionado
      → invalida cache → SprintCard atualiza
```

**IMPORTANTE:** Radix UI — não usar `value=""` em SelectItem. Usar `value="__none__"` para opções sem valor.

---

## Tasks

- [x] 1. Criar `AddIssuesToSprintDialog.tsx` com lista de issues do backlog + checkboxes
- [x] 2. Adicionar botão "Add Issues" no `SprintCard` (apenas para planning/active)
- [x] 3. Implementar lógica de atribuição: `useAssignIssueSprint` com `sprint_id`
- [x] 4. Adicionar botão "Remove" por issue dentro do `SprintCard`
- [x] 5. Implementar remoção: `useAssignIssueSprint` com `sprint_id: null`
- [x] 6. Invalidar queries após cada operação
- [ ] 7. Testar: adicionar 3 issues a uma sprint → aparecem no card
- [ ] 8. Testar: remover issue da sprint → desaparece do card, volta ao backlog

---

## Dev Agent Record

**Agent Model Used:** Claude Opus 4.6
**Completion Notes:** Implemented all 4 ACs. Created AddIssuesToSprintDialog with multi-select checkboxes, search filtering, and batch sprint assignment. Modified SprintCard with "Add Issues" button (planning/active only) and per-issue "Remove" button with loading state. Added useAssignIssueSprint hook for flexible sprint assignment/removal. Fixed rules-of-hooks violation in SprintPage. Added sprint_id to API's IssueListItem type. Tasks 7-8 require manual testing with running backend.
**File List:**
- `frontend/src/components/sprints/AddIssuesToSprintDialog.tsx` (CREATED)
- `frontend/src/components/sprints/SprintCard.tsx` (MODIFIED)
- `frontend/src/components/sprints/index.ts` (MODIFIED)
- `frontend/src/pages/sprints/SprintPage.tsx` (MODIFIED)
- `frontend/src/hooks/useIssues.ts` (MODIFIED)
- `frontend/src/api/issues.ts` (MODIFIED - added sprint_id to IssueListItem)
- `frontend/src/components/issues/IssueRow.tsx` (MODIFIED - made onClick optional, added projectId prop)
**Change Log:**
- Added `useAssignIssueSprint` hook to useIssues.ts for batch sprint assignment
- Created AddIssuesToSprintDialog with search, select-all, multi-select, loading/error states
- SprintCard now shows "Add Issues" button for planning/active sprints, remove (X) button per issue
- SprintPage manages dialog state and passes onAddIssues callback to each SprintCard
- Fixed pre-existing rules-of-hooks violation in SprintPage (hooks called after early return)
