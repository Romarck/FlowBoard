# Story E1.6 — Connection Pool Tuning

## Status
Ready

## Description

Analyze and optimize asyncpg connection pool configuration to support 100+ concurrent users without connection exhaustion or degradation. Currently, pool configuration is default (not optimized). Under load, connection pool runs out of available connections, causing request timeouts and 503 errors.

**Problem**: Connection pool is undersized for actual traffic. Default pool_size in asyncpg too small for concurrent requests. Database CPU pressure spikes when multiple users make simultaneous requests. Connection exhaustion errors visible in logs under peak load.

**Solution**:
1. Analyze current pool usage and optimal size calculation
2. Configure pool_size, min_size, max_cached_statement_lifetime based on:
   - Expected concurrent users (100+)
   - Average query duration
   - Connection timeout settings
3. Add connection pool monitoring and alerting
4. Test with load generator to verify stability

**Impact**: Eliminate connection exhaustion errors, support concurrent load, reduce database CPU pressure, foundation for Phase 2 scaling.

## Acceptance Criteria

- [ ] Given asyncpg connection pool configuration, when analyzing current settings, then document current pool_size and actual concurrency needs
- [ ] Given load testing with 100 concurrent users, when running for 5 minutes, then zero connection timeout errors
- [ ] Given connection pool monitoring, when checking metrics, then pool usage visible (active vs. available connections)
- [ ] Given production deployment, when peak hours occur, then CPU usage stays below 50% (measured before/after)
- [ ] Given connection pool configuration, when documented, then team can explain pool tuning rationale
- [ ] Given configuration, when tested, then max connection age and idle timeout set appropriately (prevent stale connections)
- [ ] Given monitoring, when pool exhaustion occurs, then alert fires before request fails

## Scope

### IN (Included)
✅ Pool size analysis and optimization
✅ Configuration for 100+ concurrent users
✅ Connection pool monitoring setup
✅ Load testing with 100 concurrent users
✅ Before/after CPU measurement
✅ Connection timeout configuration
✅ Idle connection cleanup
✅ Documentation of configuration decisions
✅ Monitoring/alerting setup

### OUT (Not Included)
❌ New monitoring infrastructure (use existing)
❌ Database proxy/pooler (pgBouncer, PgCat)
❌ Read replicas or sharding
❌ Async connection management overhaul

## Complexity
**2** — Low to medium complexity, mostly configuration tuning and testing, straightforward changes

## Risks

**Risk: Configuration Too Aggressive, Memory Issues**
- Mitigation: Monitor memory usage during load tests
- Mitigation: Gradual rollout (staging first)
- Mitigation: Easy rollback if needed

**Risk: Load Testing Impacts Production Database**
- Mitigation: Run load tests on staging clone
- Mitigation: Use read-only queries where possible
- Mitigation: Test during off-hours

**Risk: Configuration Works Initially, Then Degrades**
- Mitigation: Extended load testing (1+ hours, not 5 mins)
- Mitigation: Monitor for memory leaks
- Mitigation: Test connection recycling

## Effort Estimate

| Task | Time | Owner |
|------|------|-------|
| Analyze current pool configuration | 2-4 hours | Backend |
| Calculate optimal pool size | 2-4 hours | Backend |
| Implement configuration changes | 2-4 hours | Backend |
| Set up monitoring/alerting | 4-6 hours | Backend/DevOps |
| Load testing (100 concurrent users) | 4-6 hours | Backend/QA |
| Measure before/after metrics | 2-4 hours | Backend |
| Documentation | 2-4 hours | Backend |
| **Total** | **1-2 days** | Backend |

## File List
- `backend/app/config.py` (MODIFIED - connection pool settings)
- `backend/app/database.py` (MODIFIED - pool initialization)
- `backend/alembic/versions/connection_pool_config.py` (NEW - migration to document changes)
- `backend/scripts/load_test.py` (NEW - load testing script)
- `backend/scripts/monitor_pool.py` (NEW - monitoring script)
- `docs/RUNBOOK-Connection-Pool.md` (NEW - operational documentation)
- `backend/tests/test_connection_pool.py` (NEW - integration tests)

## Dev Notes (updated by @dev)
- [ ] Audit current connection pool configuration
- [ ] Calculate optimal pool_size for 100+ concurrent users
- [ ] Document calculation methodology
- [ ] Update backend/app/config.py with new settings
- [ ] Configure connection timeout and recycling
- [ ] Set up pool usage monitoring
- [ ] Create load testing script (100 concurrent users, 5+ minutes)
- [ ] Run baseline measurement (before changes)
- [ ] Apply configuration changes
- [ ] Run load test again (measure improvement)
- [ ] Document configuration decisions in runbook
- [ ] Set up alerting for pool exhaustion

## QA Results (filled by @qa)
Verdict: PENDING

---

**Epic**: E1 — Phase 1: Quick Wins
**Priority**: P0 (Critical)
**Type**: Infrastructure/Optimization
**Effort**: 1-2 days
**Team**: Backend Developer(s)
